<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport"    content="width=device-width, initial-scale=1.0" />
    <meta name="author"      content="Team Kil-A-Bytes">
    <meta name="description" content="INFO 1601 Project for team Kil-A-Bytes 'The Food Vault'">
    <link rel="stylesheet"   href="/style.css">
    <title>Catalogue</title>
    <style>
      fieldset {
        border: 2px solid; 
        border-radius: 10px; 
        background-color: white; 
        width: 70%;
        margin: 0 auto;
      }

      #submit-form-button {
        cursor: pointer;
        display: inline-block;
        background: #333;
        color: white;
        font-size: 13px;
        border: 0;
        padding: 0.5em;
        padding-left: 9px;
        padding-right: 9px;
        min-width: 60px;
      }

      #restaurant-listing {
        flex-wrap: wrap; 
        justify-content: space-evenly;
        align-items: center;
        margin: 0 auto;
        width: 80%;
      }

      .vertical-card {
        width: "160px";
        padding: "20px";
      }
    </style>

    <script>
      // global variables
      let auth = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6Imtlc2hhbm1vb3NhaUBnbWFpbC5jb20iLCJmaXJzdG5hbWUiOm51bGwsImxhc3RuYW1lIjpudWxsLCJpZCI6MSwicm9sZXMiOiJ1c2VyIiwiaWF0IjoxNjQ5NDc4NTA4fQ.niRMnlB_nSOMK0DeHuutpxwCwgvyvrGjzXewdytAwAI';
      let cuisines = {};
      let areas = {};
      let restaurants = {};
      let displayContainer = document.getElementById("restaurant-listing");

      // GET for hosted NocoDB database
      async function pullData(table) {
        let results = {};
        let response = await fetch(
          `https://the-food-vault.herokuapp.com/nc/the_food_vault_scbp/api/v1/${table}?limit=100`,
          {
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'xc-auth' : auth
            }
          }
        );
        results = await response.json();
        return results;
      }

      // populate objects
      async function populateObjects() {
        cuisines = await pullData('Cuisines');
        areas = await pullData('Areas');
        restaurants = await pullData('Restaurants');

        // Loop through the JSON and add the areas to the selection list
        for (let area of areas) {
          // Create new option
          let option    = document.createElement('option');
          option.value  = area.id;
          option.text   = area.name;

          // Add the option to the selection list
          document.getElementById('area-selections').appendChild(option);
        }

        // Loop through the JSON and add the cuisines to the selection list
        for (let cuisine of cuisines) {
          // Create new option
          let option    = document.createElement('option');
          option.value  = cuisine.id;
          option.text   = cuisine.style;

          // Add the option to the selection list
          document.getElementById('cuisine-selections').appendChild(option);
        }

        // Initialise all ratings
        let ratings = [];
        for (let i = 0; i < restaurants.length; i++) {
          // Check if the rating is already in the list
          let curr_rating = restaurants[i].rating[0];
          if (!ratings.includes(curr_rating)) {
            // Create new option
            let option    = document.createElement('option');
            option.value  = curr_rating;
            option.text   = curr_rating;

            // Add the option to the selection list
            document.getElementById('rating-selections').appendChild(option);

            // Add the rating to the list
            ratings.push(curr_rating);
          }
        }
      }
      
      // get data after page finishes loading
      document.readyState === 'complete' ? populateObjects() : window.addEventListener('load', populateObjects);
    </script>
  </head>
  
  <body>
    <!-- Main View -->
    <main id="app">

      <!-- Side Nav Chat-area -->
      <div id="chatbot-area" class="side-nav collapsed">
        <a href="javascript:void(0)" class="closebutton" onclick="closeChatArea()">&times;</a>
        <iframe id="annabot-iframe" src="https://tfv-annabot.herokuapp.com/s/chat" frameborder="1" width="90%" height="90%"></iframe>
      </div>
      
      <!-- Main page content -->
      <div id="page-content">
        
        <!-- Main Navigation bar for top of page -->
        <nav id="main-nav-bar" class="nav-bar">
          <ul class="links-container">
            <a href="/index.html"><button>Home</button></a>
            <a href="/testimonials.html"><button>Testimonials</button></a>
            <a href="/catalogue.html"><button class="selected">Catalogue</button></a>
          </ul>
        </nav>

        <!-- Catalogue filter area -->
        <br><br>
        <h2><b>Browse Our Catalogue</b></h2>
        <hr><br>
        
        <section id="filter-section">
          <fieldset>
            <form id="filter-catalogue">
              <br>
              <label>Choose a cuisine/style:</label>
              <br>
              <select id="cuisine-selections" class="selection-list">
                <option value="all">Any</option>
              </select>
              <br><br>

              <label>Choose a location:</label>
              <br>
              <select id="area-selections" class="selection-list">
                <option value="all">Any</option>
              </select>
              <br><br>

              <label>Choose a rating:</label>
              <br>
              <select id="rating-selections" class="selection-list">
                <option value="all">Any</option>
              </select>
              <br><br>
              <input id="submit-form-button" type="button" value="Show Me Places!" onclick="displayData()">
    
              <p>(You can always search our entire catalogue for all areas by searching from the get-go!)</p>
            </form>
          </fieldset>
        </section>

        <br><br>

        <!-- Restaurant Listing from Database -->
        <div id="restaurant-listing" class="vertical-container"></div>
        <br><br><hr>

      </div>
    </main>

    <!-- Button to Expand Chat-area -->
    <button id="fixed-button" onclick="openChatArea()">Expand Chat</button>

    <!-- Footer -->
    <footer>
        <div class="horizontal-container">
          <p>Find Us @</p>
          <div class="vertical-container" style="width: fit-content;">
            <a href="https://www.instagram.com/thefoodvault">
              <img src="/images/instagram.png" alt="Instagram" width="30" height="30">
            </a>
            <a href="https://www.twitter.com/thefoodvault">
              <img src="/images/twitter.png" alt="Twitter" width="30" height="30">
            </a>
          </div>
          <div id="trademark">
            <p>
              &copy; The Food Vault by Team Kil-A-Bytes
            </p>
          </div>
        </div>
    </footer>
    <br>

    <script>
      displayContainer = document.getElementById('restaurant-listing');

      // Side nav controls
      function openChatArea() {
        document.getElementById("chatbot-area").classList.remove("collapsed");
        document.getElementById("chatbot-area").style.width = "390px";
        document.getElementById("page-content").style.marginLeft = "510px";
      }

      function closeChatArea() {
        document.getElementById("chatbot-area").style.width = "0";
        document.getElementById("page-content").style.marginLeft = "0";
      }

      // Div-builder for restaurant listing
      function addRestaurantCardItem(restaurant) {
        // create card for restaurant
        let card = document.createElement("div");
        card.className = "horizontal-card";
        card.onclick = function() {
          // displayRestaurant(restaurants[i].id);
          console.log('Displaying restaurant ' + restaurant.id);
        }

        // add a vertical container to card
        let vertical_container = document.createElement("div");
        vertical_container.className = "vertical-container";

        // create card header
        let card_header = document.createElement("h2")
        card_header.setAttribute("id", "restaurant-name");
        card_header.className = "vertical-card";
        card_header.innerHTML = restaurant.name;
        vertical_container.appendChild(card_header);

        // add an inner horizontal container to vertical container
        let inner_horizontal_container = document.createElement("div");
        inner_horizontal_container.className = "horizontal-container";

        // create card body
        let card_body_1 = document.createElement("h3")
        card_body_1.setAttribute("id", "dine-in");
        card_body_1.innerHTML = `Dine In: ${restaurant.dine_in ? "Yes" : "No"}`;
        inner_horizontal_container.appendChild(card_body_1);

        let card_body_2 = document.createElement("h3")
        card_body_2.setAttribute("id", "take-out");
        card_body_2.innerHTML = `Take Out: ${restaurant.take_out ? "Yes" : "No"}`;
        inner_horizontal_container.appendChild(card_body_2);

        // add inner horizontal container to vertical container
        vertical_container.appendChild(inner_horizontal_container);

        // add vertical container to card
        card.appendChild(vertical_container);

        // add card to displayContainer
        displayContainer.appendChild(card);
      }

      // Display restaurants for given cuisine
      function displayRestaurantList(cuisine_id, area_id, rating) {
        let cuisine_style = '';
        let area_name = '';
        console.log(`C: ${cuisine_id} A: ${area_id} R: ${rating}`);

        // get name of cuisine
        for (let i = 0; i < cuisines.length; i++) {
          if (cuisines[i].id === Number(cuisine_id)) {
            cuisine_style = cuisines[i].style;
          }
        }

        // get name of area
        for (let i = 0; i < areas.length; i++) {
          if (areas[i].id === Number(area_id)) {
            area_name = areas[i].name;
          }
        }
        
        // Add heading to displayContainer
        let heading;
        if (cuisine_id !== 'all' && area_id === 'all' && rating === 'all') {
          heading = `${cuisine_style} Restaurants`;
        } else if (cuisine_id === 'all' && area_id !== 'all' && rating === 'all') {
          heading = `Restaurants in ${area_name}`;
        } else if (cuisine_id === 'all' && area_id === 'all' && rating !== 'all') {
          heading = `${rating} Star Restaurants`;
        } else if (cuisine_id !== 'all' && area_id !== 'all' && rating === 'all') {
          heading = `${cuisine_style} Restaurants in ${area_name}`;
        } else if (cuisine_id !== 'all' && area_id === 'all' && rating !== 'all') {
          heading = `${rating} Star ${cuisine_style} Restaurants`;
        } else if (cuisine_id === 'all' && area_id !== 'all' && rating !== 'all') {
          heading = `${rating} Star Restaurants in ${area_name}`;
        } else if (cuisine_id !== 'all' && area_id !== 'all' && rating !== 'all') {
          heading = `${rating} Star ${cuisine_style} Restaurants in ${area_name}`;
        }

        let headingHTML = `
          <br>
          <div class="vertical-container" style="width: 100%">
            <h2 style="margin: 0 auto; padding-top: 15px; padding-bottom: 15px"><b>${heading}</b></h2>
          </div>
          <br><hr>
        `;
        displayContainer.innerHTML = headingHTML;

        // Display all restaurants for cuisine
        for (let i = 0; i < restaurants.length; i++) {
          
          // ensure cuisine matches
          if (restaurants[i].CuisinesMMList[0].id == cuisine_id) {

            // check all filters
            if (area_id === 'all' && rating === 'all') {
              console.log('Displaying all ' + restaurants[i].CuisinesMMList[0].style + ' restaurants');
              addRestaurantCardItem(restaurants[i]);
            }
            
            else if (area_id !== 'all' && rating === 'all') {
              if (restaurants[i].AreaMMList[0].id == area_id) {
                console.log('Displaying restaurants in ' + area_name);
                addRestaurantCardItem(restaurants[i]);
              }
            }
            
            else if (area_id === 'all' && rating !== 'all') {
              let rating_val = restaurants[i].rating;
              if (rating_val >= Number(rating) && rating_val < Number(rating) + 1) {
                console.log('Displaying restaurants with ' + rating + ' star rating');
                addRestaurantCardItem(restaurants[i]);
              }
            }

            else {
              console.log('Displaying restaurants in ' + area_name + ' with ' + rating + ' star rating');
              addRestaurantCardItem(restaurants[i]);
            }
          }
        }
      }

      // Populate restaurant-listing area
      async function displayData() {
        let cuisine   = document.getElementById("cuisine-selections").value;
        let area      = document.getElementById("area-selections").value;
        let rating    = document.getElementById("rating-selections").value;
        console.log(`C: ${cuisine} A: ${area} R: ${rating}`);

        // If no filters are selected, display all cuisines to select from
        if (cuisine == "all" && area == "all" && rating == "all") {
          displayContainer.innerHTML = "";

          // Check if there are any restaurants listed under each cuisine before adding to the list
          for (let each of cuisines) {
            if (each.RestaurantsMMList.length > 0) {
              let newVerticalCard = document.createElement("div");
              newVerticalCard.classList.add("vertical-card");
              newVerticalCard.setAttribute("onclick", `displayRestaurantList(${each.id}, 'all', 'all')`);
              newVerticalCard.innerHTML = `<h3 style="margin: 0 auto; padding-top: 15px; padding-bottom: 15px">${each.style}</h3>`;
              displayContainer.appendChild(newVerticalCard);
            }
          }
        }

        // Display restaurants according to filters
        else {
          displayRestaurantList(cuisine, area, rating);
        }
      }
    </script>

  </body>
</html>